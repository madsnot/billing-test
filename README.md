# billing-test
Test task for Avito. Billing Golang

## Список вопросов
При выполнении тестового задания были выявлены несколько вопросов по ТЗ.

#### + Работа с Docker и docker-compose
В связи с нехваткой времени реализация полноценно работающей dev-среды не была создана. Однако необходимые для этого файлы предоставлены.

#### + База данных
Исходя из ТЗ не особо было ясно необходимо ли сервису хранить подробную информацию об услугах и заказах. Я приняла решение сделать структуру базы не такой большой. Сервис хранит информацию о балансе пользователя: ID баланса, ID пользователя, баланс, резервный баланс (для резервирования денег) и информацию о транзакциях: ID транзакции, тип транзакции, ID пользователя, ID заказа, ID услуги, сумму, дату.

#### + Выполнение доп. задания №1
В самом задании было указано, что данные выводятся в ссылке на CSV файл в формате: название услуги 1;общая сумма выручки за отчетный период.
1. Так как созданная мной биллинг система не хранит в себе доп. информацию как "название услуги", а только её ID, то выходные данные имеют формат: ID услуги;общая сумма выручки за отчетный период.
2. В связи с нехваткой времени было решено оставить вывод данных в JSON формате, а не ссылкой на CSV файл

## Начало работы

### Скачивание
```
git clone "https://github.com/madsnot/billing-test.git"
```

### Необходимые доп. файлы
Для работы с базой данных была создана конфигурация, которая получает необходимые переменные из окружения. Чтобы проект запустился успешно необходимо в папке проекта создать env файл ".env"

```env
# Имя пользователя БД
DATABASE_USER=

# Пароль пользователя БД
DATABASE_PASS=

# Имя базы данных
DATABASE_NAME=

# SSL-подключение для шифрования клиент-серверного взаимодействия
DATABASE_SSLMODE=

# Имя драйвера
DATABASE_DRIVER=
```

### Сборка проекта и запуск
В проекте используются сторонние библиотеки поэтому необходимо их загрузить:
```
go mod download
```
Далее необходимо собрать в проекте пакеты:
```
go build ./config/config.go
go build ./routers_handlers/handlers.go
```
Запуск проекта:
```
go run .
```

## Маршрутизация
Все данные принимаются и выводятся в JSON формате. Ошибки сервера помимо вывода сообщения в JSON логируются в консоль.

### POST `/balance/topUp`
Пополняет баланс пользователя. На входе получает ID пользователя и сумму для пополнения баланса. 

#### curl запрос:
```
curl http://localhost:8080/balance/topUp --include --header "Content-Type: application/json" --request "POST" --data "{\"userId\": 1, \"amount\": 100000}"
```

#### Ответ: сообщение и статус-код`200`
```json
{
    "message": "Top up successful"
}
```

#### Обработка ошибок:
1. Ошибка сервера: сообщение и статус-код `500`
```json
{
    "message": "Internal server error"
}
```

### GET `/balance/:userId`
Выводит баланс пользователя. Получает ID пользователя в качестве параметра запроса.

#### curl запрос:
```
curl http://localhost:8080/balance/1
```

#### Ответ: баланс и статус-код `200`
```json
100000
```

#### Обработка ошибок:

1. Ошибка сервера: сообщение и статус-код `500`
```json
{
    "message": "Internal server error"
}
```
2. Пользователь не найден: сообщение и статус-код `404`
```json
{
    "message": "User not found"
}
```

### POST `/payment/reserve`
Резервирует средства на отдельном счёте для совершения покупки. Получает на вход ID пользователя, ID услуги, ID заказа и сумму на резервирование для дальнейшего списания.

#### curl запрос:
```
curl http://localhost:8080/payment/reserve --include --header "Content-Type: application/json" --request "POST" --data "{\"userId\": 1, \"serviceId\": 111, \"orderId\": 11, \"amount\": 100000}"
```
#### Ответ: сообщение и статус-код `200`
```json
{
    "message": "Reserve successful"
}
```

#### Обработка ошибок:

1. Ошибка сервера: сообщение и статус-код `500`
```json
{
    "message": "Internal server error"
}
```
2. Пользователь не найден: сообщение и статус-код `404`
```json
{
    "message": "User not found"
}
```
3. Недостаточно средств: сообщение и статус-код `400`
```json
{
    "message": "Account has insufficient funds"
}
```

### POST `/payment`
Списывает зарезервированные средства. Получает на вход ID пользователя, ID услуги, ID заказа и сумму списания.

#### curl запрос:
```
curl http://localhost:8080/payment --include --header "Content-Type: application/json" --request "POST" --data "{\"userId\": 1, \"serviceId\": 111, \"orderId\": 11, \"amount\": 100000}"
```

#### Ответ: сообщение и статус-код `200`
```json
{
    "message": "Write-off successful"
}
```

#### Обработка ошибок:

1. Ошибка сервера: сообщение и статус-код `500`
```json
{
    "message": "Internal server error"
}
```
2. Списание по данному заказу с услугой для пользователя было уже произведено: сообщение и статус-код `400`
```json
{
    "message": "Write-off has already done"
}
```
3. Транзакция резервирования суммы для списания не найдена: сообщение и статус-код `400`
```json
{
    "message": "Reserve transaction not found"
}
```
4. Запрошенная сумма средств не совпадает с зарезервированной: сообщение и статус-код `400`
```json
{
    "message": "Error the order amount"
}
```

### POST `/report`
Выдаёт отчёт за предоставленный период (за месяц). Получает на вход период в формате год-месяц.

#### curl запрос:
```
curl http://localhost:8080/report --include --header "Content-Type: application/json" --request "POST" --data "{\"period\": \"2022-11\"}"
```

#### Ответ: отчёт о доходах и статус-код `200`
```json
[
    {
        "service_id": 111,
        "amount": 100000
    },
    {
        "service_id": 222,
        "amount": 3000
    },
    {
        "service_id": 333,
        "amount": 100
    }
]
```

#### Обработка ошибок:

1. Ошибка сервера: сообщение и статус-код `500`
```json
{
    "message": "Internal server error"
}
```